<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RYU 재고관리 시스템</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #root { position: relative; z-index: 0; } /* 모바일 입력 버그 수정 */
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .table-container { max-height: 60vh; overflow-y: auto; } 
        
        .product-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            position: absolute;
            width: 100%; 
            z-index: 1100;
        }
        .product-search-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .product-search-item:last-child { border-bottom: none; }
        .product-search-item:hover { background-color: #f0f0f0; }

        .toggle-radio { display: none; }
        .toggle-label {
            padding: 8px 16px; background-color: #e5e7eb; color: #4b5563;
            border-radius: 6px; cursor: pointer; transition: all 0.2s;
        }
        .toggle-radio:checked + .toggle-label {
            background-color: #3b82f6; color: white; font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // --- 아이콘 컴포넌트 ---
        const Search = () => React.createElement('svg', { width: '20', height: '20', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('circle', { cx: '11', cy: '11', r: '8' }), React.createElement('path', { d: 'm21 21-4.35-4.35' }));
        const Package = () => React.createElement('svg', { width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'm7.5 4.27 9 5.15' }), React.createElement('path', { d: 'M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z' }), React.createElement('path', { d: 'M3.3 7 12 12l8.7-5' }), React.createElement('path', { d: 'M12 22V12' }));
        const MapPin = () => React.createElement('svg', { width: '20', height: '20', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z' }), React.createElement('circle', { cx: '12', cy: '10', r: '3' }));
        const Plus = () => React.createElement('svg', { width: '20', height: '20', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M5 12h14' }), React.createElement('path', { d: 'M12 5v14' }));
        const CopyPlus = () => React.createElement('svg', { width: '12', height: '12', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('rect', { width: '14', height: '14', x: '8', y: '8', rx: '2', ry: '2' }), React.createElement('path', { d: 'M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2' }), React.createElement('path', { d: 'M15 14h-6' }), React.createElement('path', { d: 'M12 11v6' }));
        const Trash = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M3 6h18' }), React.createElement('path', { d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2' }), React.createElement('line', { x1: '10', y1: '11', x2: '10', y2: '17' }), React.createElement('line', { x1: '14', y1: '11', x2: '14', y2: '17' }));
        const X = () => React.createElement('svg', { width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M18 6 6 18' }), React.createElement('path', { d: 'M6 6l12 12' }));
        const Save = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z' }), React.createElement('polyline', { points: '17,21 17,13 7,13 7,21' }), React.createElement('polyline', { points: '7,3 7,8 15,8' }));
        const RefreshCw = ({ className }) => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className }, React.createElement('path', { d: 'M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8' }), React.createElement('path', { d: 'M21 3v5h-5' }), React.createElement('path', { d: 'M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16' }), React.createElement('path', { d: 'M8 16H3v5' }));
        const Database = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('ellipse', { cx: '12', cy: '5', rx: '9', ry: '3' }), React.createElement('path', { d: 'M3 5v14c0 1.66 4.03 3 9 3s9-1.34 9-3V5' }), React.createElement('path', { d: 'M3 12c0 1.66 4.03 3 9 3s9-1.34 9-3' }));
        const LogIn = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4' }), React.createElement('polyline', { points: '10 17 15 12 10 7' }), React.createElement('line', { x1: '15', y1: '12', x2: '3', y2: '12' }));
        const LogOut = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4' }), React.createElement('polyline', { points: '16 17 21 12 16 7' }), React.createElement('line', { x1: '21', y1: '12', x2: '9', y2: '12' }));
        const Download = () => React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2' }, React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), React.createElement('polyline', { points: '7 10 12 15 17 10' }), React.createElement('line', { x1: '12', y1: '15', x2: '12', y2: '3' }));


        const InventoryApp = () => {
            // --- 상태 변수 ---
            const [locationData, setLocationData] = useState([]);
            const [productData, setProductData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [warehouseDetails, setWarehouseDetails] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [accessToken, setAccessToken] = useState(null);
            const [googleClient, setGoogleClient] = useState(null); 
            const [searchAttempted, setSearchAttempted] = useState(false);
            // const [showSetup, setShowSetup] = useState(false); // (삭제됨)
            const [showWarehouseModal, setShowWarehouseModal] = useState(false);
            const [selectedWarehouse, setSelectedWarehouse] = useState(null);
            const [showAddLocation, setShowAddLocation] = useState(false);
            const [showEditModal, setShowEditModal] = useState(false); 
            const [showProductSearchModal, setShowProductSearchModal] = useState(false); 
            const [searchModalContext, setSearchModalContext] = useState('add'); 
            const [inputMode, setInputMode] = useState('direct'); 
            const [existingItemsAtLocation, setExistingItemsAtLocation] = useState([]);
            const [itemsToDeleteSelection, setItemsToDeleteSelection] = useState(new Set());
            const [editData, setEditData] = useState({}); 
            const [newLocation, setNewLocation] = useState({}); 

            // --- 설정값 하드코딩 ---
            const [sheetsConfig, setSheetsConfig] = useState({
                locationSheetId: '11xp8iIal3oCVDyLAUrSZyNKvLntgjaUX5H6dmfvq4po', 
                productSheetId: '1MyoiAM3jL-WULsZJmbQBH97dpqR1VIdpvkZ4dbue6FY', 
                apiKey: 'AIzaSyB1RFJ10MlBnfrTZYK4IQHgyuMbQ_MGvGo', 
                clientId: '186232173029-7d25ng2i9k4jg5t23c811t2itn34vibd.apps.googleusercontent.com'
            });

            // --- Google Auth 클라이언트 초기화 (동적 스크립트 로더) ---
            const loadSheetDataCallback = useCallback((token) => {
                loadFromGoogleSheets(token);
            }, [sheetsConfig.locationSheetId, sheetsConfig.productSheetId]); 

            useEffect(() => {
                if (sheetsConfig.clientId) {
                    const script = document.createElement('script');
                    script.src = 'https://accounts.google.com/gsi/client';
                    script.async = true;
                    script.defer = true;
                    
                    script.onload = () => {
                        if (!window.google || !window.google.accounts) {
                            console.error("Google GSI 스크립트는 로드되었으나, 'google.accounts' 객체를 찾을 수 없습니다.");
                            alert("Google 인증 라이브러리 로드에 실패했습니다. 페이지를 새로고침 해주세요.");
                            return;
                        }
                        try {
                            const client = google.accounts.oauth2.initTokenClient({
                                client_id: sheetsConfig.clientId,
                                scope: 'https://www.googleapis.com/auth/spreadsheets', 
                                callback: (tokenResponse) => {
                                    if (tokenResponse && tokenResponse.access_token) {
                                        setAccessToken(tokenResponse.access_token);
                                        setIsLoggedIn(true); 
                                        loadSheetDataCallback(tokenResponse.access_token); 
                                    }
                                },
                            });
                            setGoogleClient(client); 
                        } catch (error) { 
                            console.error("GSI 클라이언트 초기화 오류:", error); 
                            alert("Google 인증 클라이언트 초기화에 실패했습니다.");
                        }
                    };
                    
                    script.onerror = () => {
                        alert("Google 인증 스크립트를 불러오는 데 실패했습니다. 인터넷 연결을 확인하세요.");
                    };
                    
                    document.body.appendChild(script);

                    return () => {
                        if(document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                    };

                } else {
                     alert("오류: 클라이언트 ID가 코드에 설정되지 않았습니다.");
                }
            }, [sheetsConfig.clientId, loadSheetDataCallback]); 
            
            
            // --- '추가 모달' 실시간 위치 감시 useEffect (혼적용) ---
            useEffect(() => {
                if (!showAddLocation) return; 
                const locationNumber = generateLocationNumber(newLocation);
                if (!locationNumber || locationNumber.includes("?")) {
                    setExistingItemsAtLocation([]); 
                    setItemsToDeleteSelection(new Set());
                    return;
                }
                const existingItems = locationData.filter(item => item['로케이션번호'] === locationNumber);
                setExistingItemsAtLocation(existingItems); 
                setItemsToDeleteSelection(new Set()); 
            }, [newLocation, locationData, showAddLocation]); // <-- 의존성 수정됨

            // --- 로그인/로그아웃 함수 ---
            const handleAuthClick = () => { 
                if (googleClient) { 
                    googleClient.requestAccessToken(); 
                } else { 
                    alert('Google Client가 초기화되지 않았습니다. 잠시 후 다시 시도해주세요.'); 
                } 
            };
            const handleSignoutClick = () => { if (accessToken) { try { google.accounts.oauth2.revoke(accessToken, () => { setAccessToken(null); setIsLoggedIn(false); setLocationData([]); setProductData([]); setLastSync(null); alert('로그아웃되었습니다.'); }); } catch(error) { setAccessToken(null); setIsLoggedIn(false); setLocationData([]); setProductData([]); setLastSync(null); } } };

            // --- 데이터 로드 함수 (API 키 로직 제거) ---
            const loadFromGoogleSheets = useCallback(async (token = accessToken) => { 
                const { locationSheetId, productSheetId } = sheetsConfig;
                if (!token) { return; } 
                if (!locationSheetId || !productSheetId) { alert('시트 ID가 코드에 설정되지 않았습니다.'); return; }
                setIsLoading(true);
                const createFetchRequest = (sheetId, range = 'Sheet1') => { 
                    let url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}`; 
                    const options = { method: 'GET', headers: { 'Authorization': `Bearer ${token}` } };
                    return fetch(url, options);
                };
                try {
                    const fetchPromises = [ createFetchRequest(locationSheetId, 'Sheet1!A:J'), createFetchRequest(productSheetId) ];
                    const responses = await Promise.all(fetchPromises);
                    for (const res of responses) {
                        if (!res.ok) {
                            const errorData = await res.json();
                            let errorMsg = errorData.error.message || '데이터 로드 실패';
                            if (res.status === 401 || res.status === 403) { errorMsg += "\n로그인이 만료되었거나 권한이 없습니다."; setAccessToken(null); setIsLoggedIn(false); }
                            else if (res.status === 404) { errorMsg += "\n시트 ID를 확인해주세요."; }
                            else if (errorMsg.includes("unable to parse range")) { errorMsg += "\n시트의 '탭 이름'이 'Sheet1'이거나 범위(A:J)가 맞는지 확인해주세요."; }
                            throw new Error(errorMsg);
                        }
                    }
                    const results = await Promise.all(responses.map(res => res.json()));
                    const processSheetData = (resultData, startIndex = 2) => { 
                        if (!resultData || !resultData.values) return [];
                        const headers = resultData.values[0];
                        const rows = resultData.values.slice(1);
                        return rows.map((row, index) => {
                            const item = {};
                            headers.forEach((header, colIndex) => item[header] = row[colIndex] || '');
                            item.originalRowIndex = index + startIndex; 
                            return item;
                        });
                    };
                    setLocationData(processSheetData(results[0])); 
                    setProductData(processSheetData(results[1])); 
                    setLastSync(new Date().toLocaleString());
                } catch (error) {
                    console.error('로드 오류:', error);
                    alert(`데이터 로드 중 오류가 발생했습니다.\n${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            }, [accessToken, sheetsConfig]); 

            // --- 데이터 로드 트리거 useEffect ---
            useEffect(() => {
                // (로그인 시 GSI 콜백에서 loadFromGoogleSheets가 호출됨)
            }, []); 

            const loadSampleData = () => {}; 
            // const saveConfig = () => {}; (삭제됨)

            // --- 메인 검색 기능 (유통사/레이블 추가) ---
            const handleSearch = () => {
                setSearchAttempted(true); 
                setSelectedProduct(null); 
                if (!searchTerm.trim()) { setSearchResults([]); return; }
                const term = searchTerm.toLowerCase();
                const results = [];
                locationData.forEach(item => {
                    const albumCode = (item['앨범코드'] || '').toString().toLowerCase(); 
                    const albumName = (item['앨범명'] || '').toString().toLowerCase(); 
                    const artist = (item['아티스트명'] || '').toString().toLowerCase(); 
                    const location = (item['로케이션번호'] || '').toString().toLowerCase();
                    const distributor = (item['유통사'] || '').toString().toLowerCase(); 
                    const label = (item['레이블'] || '').toString().toLowerCase();     
                    if (albumCode.includes(term) || albumName.includes(term) || artist.includes(term) || location.includes(term) || distributor.includes(term) || label.includes(term)) {
                        const existing = results.find(r => r.albumCode === item['앨범코드']); 
                        if (existing) {
                            existing.totalStock += parseInt(String(item['총재고'] || '0').replace(/,/g, '')) || 0; 
                            existing.locations.push(item);
                        } else {
                            results.push({
                                albumCode: item['앨범코드'], albumName: item['앨범명'], artist: item['아티스트명'],
                                distributor: item['유통사'], label: item['레이블'], 
                                totalStock: parseInt(String(item['총재고'] || '0').replace(/,/g, '')) || 0,
                                locations: [item]
                            });
                        }
                    }
                });
                setSearchResults(results);
            };

            // --- UI 로직 (창고 요약/선택) (0개 재고 로직 추가) ---
            const getWarehouseSummary = (locations) => {
                const summary = { 
                    A1: { count: 0, label: '메인출고창고', hasLocation: false }, A2: { count: 0, label: '천막창고', hasLocation: false }, 
                    B1: { count: 0, label: 'B동메인', hasLocation: false }, B2: { count: 0, label: 'B동천막', hasLocation: false }, 
                    C1: { count: 0, label: 'C동메인', hasLocation: false }, C2: { count: 0, label: 'C동천막', hasLocation: false }
                };
                locations.forEach(location => {
                    const warehouse = (location['로케이션번호'] || '').split('-')[0];
                    if (summary[warehouse]) {
                        summary[warehouse].count += parseInt(String(location['총재고'] || '0').replace(/,/g, '')) || 0; 
                        summary[warehouse].hasLocation = true; 
                    }
                });
                return summary;
            };
            const selectProduct = (product) => {
                setSelectedProduct(product);
                setWarehouseDetails(getWarehouseSummary(product.locations));
            };
            const showWarehouseDetails = (warehouseCode) => {
                if (!selectedProduct) return;
                const warehouseLocations = selectedProduct.locations.filter(loc => (loc['로케이션번호'] || '').startsWith(warehouseCode));
                const labels = { A1: '메인출고창고', A2: '천막창고', B1: 'B동메인', B2: 'B동천막', C1: 'C동메인', C2: 'C동천막' };
                setSelectedWarehouse({ code: warehouseCode, label: labels[warehouseCode] || warehouseCode, locations: warehouseLocations });
                setShowWarehouseModal(true);
            };

            // --- '편집 모달' 열기 함수 (10열 데이터 로드) ---
            const startEditLocation = (location) => {
                if (!isLoggedIn) { alert('데이터를 수정하려면 Google 로그인이 필요합니다.'); return; }
                setEditData({
                    locationNumber: location['로케이션번호'], originalRowIndex: location.originalRowIndex, 
                    albumCode: location['앨범코드'] || '', albumName: location['앨범명'] || '',     
                    artist: location['아티스트명'] || '', distributor: location['유통사'] || '', 
                    label: location['레이블'] || '', memo: location['메모'] || '',         
                    itemsPerBox: location['내품수'] || 0, boxCount: location['박스수량'] || 0
                });
                setInputMode('direct'); 
                setShowEditModal(true); 
                setShowWarehouseModal(false); 
            };
            
            // --- '수정' API 연동 함수 (10열 데이터 전송, Unique ID로 수정) ---
            const saveLocationEdit = async () => {
                if (!isLoggedIn) { alert('Google 로그인이 필요합니다.'); return; }
                const editingLocNum = editData.locationNumber; 
                const rowIndex = editData.originalRowIndex; 
                if (!rowIndex) { alert('오류: 원본 행 번호를 찾을 수 없습니다.'); return; }
                setIsLoading(true);
                const totalStock = (editData.itemsPerBox || 0) * (editData.boxCount || 0);
                const rowData = [
                    editData.locationNumber, editData.distributor, editData.albumCode, editData.albumName,
                    editData.artist, editData.label, editData.itemsPerBox, editData.boxCount,
                    totalStock, editData.memo
                ];
                const SPREADSHEET_ID = sheetsConfig.locationSheetId;
                const RANGE = `Sheet1!A${rowIndex}:J${rowIndex}`; 
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?valueInputOption=USER_ENTERED`,
                        {
                            method: 'PUT', 
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ values: [rowData] })
                        }
                    );
                    const result = await response.json();
                    if (response.ok) {
                        alert(`수정 완료: ${editingLocNum}이(가) 수정되었습니다.`);
                        loadFromGoogleSheets(accessToken); 
                        setShowEditModal(false); 
                    } else {
                        throw new Error(result.error.message || '데이터 수정에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('Google Sheet 수정 오류:', error);
                    alert(`수정 오류: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- '추가 모달' 열기 함수 ---
            const openAddLocationModal = () => {
                if (!isLoggedIn) { alert('로케이션을 추가하려면 Google 로그인이 필요합니다.'); return; }
                setNewLocation({
                    warehouse: 'A1', type: 'P', rackNum: '01', tier: 'R1', rackPos: '', 
                    groundRow: '01', groundPos: '', productCode: '', productName: '',
                    artist: '', label: '', distributor: '', memo: '', 
                    itemsPerBox: 0, boxCount: 0
                });
                setInputMode('direct'); 
                setShowAddLocation(true);
                setExistingItemsAtLocation([]); 
            };

            // --- '혼적' (기존 위치에 추가) 함수 ---
            const handleMixLoad = (location) => {
                const locNum = location['로케이션번호'];
                const parts = locNum.split('-');
                let locState = { warehouse: parts[0], type: parts[1].charAt(0) };
                if (locState.type === 'P' && parts[1] && parts[2]) {
                    locState.rackNum = parts[1].substring(1);
                    locState.tier = parts[2].substring(0, 2);
                    locState.rackPos = parts[2].substring(2);
                } else if (locState.type === 'G' && parts[1] && parts[2]) { 
                    locState.groundRow = parts[1].substring(1);
                    locState.groundPos = parts[2];
                } else {
                    locState = { warehouse: 'A1', type: 'P', rackNum: '01', tier: 'R1', rackPos: '' };
                }
                setNewLocation({
                    ...locState,
                    productCode: '', productName: '', artist: '', label: '', distributor: '', memo: '',
                    itemsPerBox: 0, boxCount: 0
                });
                setInputMode('search'); 
                setShowAddLocation(true);
                setShowWarehouseModal(false); 
            };

            // --- !!! 새 로케이션 번호 생성기 (G타입 2자리 버그 수정됨) !!! ---
            const generateLocationNumber = (data) => {
                if (!data || !data.warehouse) return '';
                const { warehouse, type, rackNum, tier, rackPos, groundRow, groundPos } = data;
                if (type === 'P') {
                    if (!rackNum || !tier || !rackPos || !rackPos.trim()) return `${warehouse}-${type}${rackNum || '??'}-${tier || '??'}??`;
                    const pos = rackPos.padStart(2, '0'); // P-타입 포지션 (2자리)
                    return `${warehouse}-${type}${rackNum}-${tier}${pos}`;
                } else { // type === 'G'
                    if (!groundRow || !groundPos || !groundPos.trim()) return `${warehouse}-${type}${groundRow || '??'}-???`;
                    const pos = groundPos.padStart(2, '0'); // <-- !!! 3에서 2로 수정됨 !!!
                    return `${warehouse}-${type}${groundRow}-${pos}`;
                }
            };

            // --- '추가' API 연동 함수 (무조건 Append) ---
            const addNewLocation = async () => { 
                if (!isLoggedIn) { return; }
                const locationNumber = generateLocationNumber(newLocation);
                if (locationNumber.includes("?")) { alert("랙/칸 번호 또는 그라운드 순서 번호를 입력해주세요."); return; }
                setIsLoading(true);
                const totalStock = (newLocation.itemsPerBox || 0) * (newLocation.boxCount || 0);
                const newRowData = [
                    locationNumber, newLocation.distributor, newLocation.productCode, newLocation.productName,
                    newLocation.artist, newLocation.label, newLocation.itemsPerBox, newLocation.boxCount,
                    totalStock, newLocation.memo
                ];
                const SPREADSHEET_ID = sheetsConfig.locationSheetId;
                const RANGE = 'Sheet1!A:J'; 
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}:append?valueInputOption=USER_ENTERED`,
                        {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ values: [newRowData] })
                        }
                    );
                    const result = await response.json();
                    if (response.ok) {
                        const message = existingItemsAtLocation.length > 0 ? `(혼적) 저장 완료: ${locationNumber}` : `(신규) 저장 완료: ${locationNumber}`;
                        alert(message);
                        loadFromGoogleSheets(accessToken); 
                        setShowAddLocation(false); 
                    } else {
                        throw new Error(result.error.message || '데이터 저장에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('Google Sheet 저장 오류:', error);
                    alert(`저장 오류: ${error.message}\n인터넷 연결이나 시트 권한을 확인해주세요.`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            // --- '선택 삭제' API 연동 함수 (Batch Delete) ---
            const handleDeleteSelectedItems = async () => {
                if (!isLoggedIn) { alert('로그인이 필요합니다.'); return; }
                const rowsToDelete = Array.from(itemsToDeleteSelection); 
                if (rowsToDelete.length === 0) {
                    alert('삭제할 항목을 먼저 체크해주세요.');
                    return;
                }
                const confirmDelete = window.confirm(
                    `[경고] 총 ${rowsToDelete.length}개의 항목을 삭제하시겠습니까?\n\n이 작업은 Google Sheets 원본에서 해당 행들을 **영구적으로 삭제**하며 되돌릴 수 없습니다!`
                );
                if (!confirmDelete) { return; }
                setIsLoading(true);
                const SPREADSHEET_ID = sheetsConfig.locationSheetId;
                const SHEET_NUMERIC_ID = 0; 
                const sortedRowsToDelete = rowsToDelete.sort((a, b) => b - a); 
                const requests = sortedRowsToDelete.map(rowIndex => ({
                    "deleteDimension": { "range": {
                        "sheetId": SHEET_NUMERIC_ID, "dimension": "ROWS",
                        "startIndex": rowIndex - 1, "endIndex": rowIndex
                    }}
                }));
                const requestBody = { requests };
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`,
                        {
                            method: 'POST', 
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        }
                    );
                    const result = await response.json();
                    if (response.ok) {
                        alert(`삭제 완료: ${rowsToDelete.length}개 항목이 Google 시트에서 영구적으로 삭제되었습니다.`);
                        loadFromGoogleSheets(accessToken); 
                        setShowAddLocation(false); 
                    } else {
                        throw new Error(result.error.message || '데이터 삭제에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('Google Sheet 일괄 삭제 오류:', error);
                    alert(`삭제 오류: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            // --- '단일 삭제' API 연동 함수 ---
            const deleteLocation = async (rowIndex) => { 
                if (!isLoggedIn) { alert('데이터를 삭제하려면 Google 로그인이 필요합니다.'); return; }
                const locationToDelete = locationData.find(item => item.originalRowIndex === rowIndex); 
                if (!locationToDelete) {
                    alert('오류: 삭제할 행을 찾을 수 없습니다. 데이터를 새로고침 해주세요.');
                    return;
                }
                const confirmDelete = window.confirm(
                    `[경고] 로케이션 [${locationToDelete['로케이션번호']}] (${locationToDelete['앨범명'] || locationToDelete['상품명']}) 을(를) 삭제하시겠습니까?\n\n이 작업은 Google Sheets 원본에서 해당 행을 **영구적으로 삭제**하며 되돌릴 수 없습니다!`
                );
                if (!confirmDelete) { return; }
                setIsLoading(true);
                const SPREADSHEET_ID = sheetsConfig.locationSheetId;
                const SHEET_NUMERIC_ID = 0; 
                const requestBody = { requests: [ { "deleteDimension": { "range": {
                    "sheetId": SHEET_NUMERIC_ID, "dimension": "ROWS", "startIndex": rowIndex - 1, "endIndex": rowIndex }}} ]};
                try {
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`,
                        {
                            method: 'POST', 
                            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        }
                    );
                    const result = await response.json();
                    if (response.ok) {
                        alert(`삭제 완료: [${locationToDelete['로케이션번호']}] 행이 Google 시트에서 영구적으로 삭제되었습니다.`);
                        loadFromGoogleSheets(accessToken); 
                        setShowWarehouseModal(false); 
                        selectProduct(null); 
                    } else {
                        throw new Error(result.error.message || '데이터 삭제에 실패했습니다.');
                    }
                } catch (error) {
                    console.error('Google Sheet 삭제 오류:', error);
                    alert(`삭제 오류: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- 체크박스 핸들러 ---
            const handleItemDeleteToggle = (rowIndex) => {
                const newSelection = new Set(itemsToDeleteSelection);
                if (newSelection.has(rowIndex)) { newSelection.delete(rowIndex); } 
                else { newSelection.add(rowIndex); }
                setItemsToDeleteSelection(newSelection);
            };

            // --- 통합 상품 검색 모달 관련 함수 (5개 필드 매핑) ---
            const openProductSearchModal = (context) => {
                setSearchModalContext(context); 
                setShowProductSearchModal(true);
            };
            const onProductSelectFromModal = (product) => {
                const selectedData = {
                    code: product['관리코드'] || '', name: product['상품명'] || '',
                    spec: product['규격'] || '', label: product['적재위치'] || '',
                    distributor: product['소분류명'] || ''
                };
                if (searchModalContext === 'add') {
                    setNewLocation({ 
                        ...newLocation,
                        productCode: selectedData.code, productName: selectedData.name, artist: selectedData.spec,
                        label: selectedData.label, distributor: selectedData.distributor,
                        memo: product['비고'] || '' 
                    });
                } else { 
                    setEditData({ 
                        ...editData,
                        albumCode: selectedData.code, albumName: selectedData.name, artist: selectedData.spec,
                        label: selectedData.label, distributor: selectedData.distributor,
                        memo: product['비고'] || editData.memo 
                    });
                }
                setShowProductSearchModal(false); 
            };
            
            // --- CSV 내보내기 헬퍼 함수 (10열 헤더) ---
            const exportToCSV = (data, filename) => {
                if (!data || data.length === 0) { alert('내보낼 데이터가 없습니다.'); return; }
                const headers = ['로케이션번호', '유통사', '앨범코드', '앨범명', '아티스트명', '레이블', '내품수', '박스수량', '총재고', '메모'];
                const escapeCSV = (val) => {
                    if (val === undefined || val === null) return '';
                    let str = String(val);
                    if (str.includes(',')) { str = `"${str.replace(/"/g, '""')}"`; }
                    return str;
                };
                const headerRow = headers.join(',') + '\n';
                const dataRows = data.map(item => {
                    return headers.map(headerKey => escapeCSV(item[headerKey])).join(',');
                }).join('\n');
                const csvString = headerRow + dataRows;
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blobWithBom = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blobWithBom);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };


            // --- --- --- --- --- --- ---
            // --- React 렌더링 (HTML) ---
            // --- --- --- --- --- --- ---
            return React.createElement('div', { className: 'max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen' },
                React.createElement('h1', { className: 'text-3xl font-bold text-center mb-8 text-gray-800' }, React.createElement(Package, { style: { display: 'inline-block', marginRight: '8px' } }), 'RYU 재고관리 시스템'), 
                React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-4 mb-6' },
                    React.createElement('div', { className: 'flex gap-2 flex-wrap items-center' },
                        React.createElement('button', { onClick: () => loadFromGoogleSheets(accessToken), disabled: isLoading, className: `px-4 py-2 rounded text-white flex items-center gap-2 ${isLoading ? 'bg-gray-400' : 'bg-green-500 hover:bg-green-600'}` }, React.createElement(RefreshCw, { className: isLoading ? 'loading' : '' }), '새로고침'),
                        React.createElement('button', { onClick: () => exportToCSV(locationData, 'full_inventory_report.csv'), disabled: locationData.length === 0, className: 'px-4 py-2 bg-teal-500 text-white rounded hover:bg-teal-600 flex items-center gap-2 disabled:bg-gray-400' }, React.createElement(Download), 'CSV 전체 다운로드'),
                        
                        // --- !!! (신규) 로그인 버튼 로딩 상태 처리 !!! ---
                        !isLoggedIn ? 
                            (
                                googleClient ? // 클라이언트가 로드 되었나?
                                    React.createElement('button', { // 로드됨: 로그인 버튼 표시
                                        onClick: handleAuthClick,
                                        className: 'px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 flex items-center gap-2'
                                    }, React.createElement(LogIn), 'Google 로그인')
                                :
                                    React.createElement('button', { // 로드 안됨: 비활성 로딩 버튼 표시
                                        className: 'px-4 py-2 bg-gray-400 text-white rounded flex items-center gap-2 cursor-not-allowed',
                                        disabled: true
                                    }, React.createElement(RefreshCw, { className: 'loading' }), '인증 초기화 중...')
                            )
                        : // (로그인 됨):
                            React.createElement('button', { onClick: handleSignoutClick, className: 'px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 flex items-center gap-2' }, React.createElement(LogOut), '로그아웃'),
                        
                        React.createElement('div', { className: 'flex items-center gap-2 text-sm text-gray-600' }, React.createElement(Database), `위치: ${locationData.length}건, 상품: ${productData.length}건`),
                        lastSync && React.createElement('div', { className: 'text-xs text-gray-500' }, `마지막 동기화: ${lastSync}`)
                    )
                ),
                React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6 mb-6' },
                    React.createElement('div', { className: 'flex gap-4 mb-4' },
                        React.createElement('div', { className: 'flex-1' }, React.createElement('input', { type: 'text', placeholder: '로케이션, 앨범코드, 앨범명, 아티스트, 유통사, 레이블 검색...', value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), onKeyPress: (e) => e.key === 'Enter' && handleSearch(), className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent' })),
                        React.createElement('button', { onClick: handleSearch, className: 'px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2' }, React.createElement(Search), '검색'),
                        React.createElement('button', {
                            onClick: openAddLocationModal,
                            className: `px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 ${!isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`,
                            title: !isLoggedIn ? '로그인 필요' : '새 로케이션 추가', disabled: !isLoggedIn
                        }, React.createElement(Plus), '로케이션 추가')
                    )
                ),
                (searchResults.length > 0 && !selectedProduct) && React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6 mb-6' },
                    React.createElement('h2', { className: 'text-xl font-semibold mb-4' }, `검색 결과 (${searchResults.length}건)`),
                    React.createElement('div', { className: 'space-y-3' },
                        searchResults.map((product) => 
                            React.createElement('div', { key: product.albumCode, className: 'border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer', onClick: () => selectProduct(product) },
                                React.createElement('div', { className: 'flex justify-between items-start' },
                                    React.createElement('div', null,
                                        React.createElement('h3', { className: 'font-semibold text-lg' }, product.albumName), 
                                        React.createElement('p', { className: 'text-gray-600' }, `아티스트명: ${product.artist}`), 
                                        React.createElement('p', { className: 'text-sm text-gray-500' }, `앨범코드: ${product.albumCode} | 유통사: ${product.distributor || 'N/A'} | 레이블: ${product.label || 'N/A'}`) 
                                    ),
                                    React.createElement('div', { className: 'text-right' },
                                        React.createElement('p', { className: 'text-xl font-bold text-blue-600' }, `${product.totalStock.toLocaleString()}개`), 
                                        React.createElement('p', { className: 'text-sm text-gray-500' }, '총 재고')
                                    )
                                )
                            )
                        )
                    )
                ), 
                selectedProduct && React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6 mb-6' },
                    React.createElement('div', { className: 'border-b pb-4 mb-4' },
                         React.createElement('div', {className: 'flex justify-between items-start'}, 
                            React.createElement('div', null, 
                                React.createElement('h3', { className: 'font-semibold text-lg' }, selectedProduct.albumName), 
                                React.createElement('p', { className: 'text-gray-600' }, `아티스트명: ${selectedProduct.artist}`), 
                                React.createElement('p', { className: 'text-sm text-gray-500' }, `앨범코드: ${selectedProduct.albumCode} | 유통사: ${selectedProduct.distributor || 'N/A'} | 레이블: ${selectedProduct.label || 'N/A'}`),
                                React.createElement('p', { className: 'text-xl font-bold text-blue-600 mt-2' }, `총 재고: ${selectedProduct.totalStock.toLocaleString()}개`)
                            ),
                            React.createElement('button', { 
                                onClick: () => exportToCSV(selectedProduct.locations, `${selectedProduct.albumCode}_report.csv`),
                                className: 'px-3 py-1 bg-teal-500 text-white text-xs rounded-lg hover:bg-teal-600 flex items-center gap-1 h-fit'
                            }, React.createElement(Download), '리포트 다운로드')
                        )
                    ),
                    warehouseDetails && React.createElement('div', null,
                        React.createElement('h2', { className: 'text-xl font-semibold my-4' }, 
                            React.createElement(MapPin, { style: { display: 'inline-block', marginRight: '8px' } }),
                            `[${selectedProduct.albumCode}] ${selectedProduct.albumName} - 창고별 재고현황`
                        ),
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                            Object.entries(warehouseDetails).map(([warehouse, info]) => {
                                let countClass = 'text-gray-400'; 
                                if (info.count > 0) { countClass = 'text-green-600'; }
                                else if (info.hasLocation) { countClass = 'text-gray-800 font-bold'; }
                                return React.createElement('div', { key: warehouse, className: 'border border-gray-200 rounded-lg p-4' },
                                    React.createElement('div', { className: 'flex justify-between items-center mb-2' },
                                        React.createElement('h3', { className: 'font-semibold' }, `${warehouse} (${info.label})`),
                                        info.hasLocation && React.createElement('button', { 
                                            onClick: () => showWarehouseDetails(warehouse),
                                            className: 'px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600',
                                            title: '상세보기'
                                        }, '상세보기')
                                    ),
                                    React.createElement('p', { className: `text-2xl font-bold text-center py-2 ${countClass}` }, `${info.count.toLocaleString()}개`) 
                                );
                            })
                        )
                    )
                ),
                (searchAttempted && searchResults.length === 0 && !selectedProduct) && React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6 mb-6 text-center' },
                     React.createElement('p', { className: 'text-gray-600 font-semibold' }, '검색 결과 0건')
                ),
                
                showWarehouseModal && React.createElement('div', { className: 'modal-overlay' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-6 w-full max-w-7xl max-h-[90vh] overflow-y-auto' }, 
                        React.createElement('div', { className: 'flex justify-between items-center mb-4' },
                            React.createElement('h2', { className: 'text-xl font-semibold' }, `${selectedWarehouse.code} (${selectedWarehouse.label}) 상세현황`),
                            React.createElement('button', { onClick: () => setShowWarehouseModal(false), className: 'text-gray-500 hover:text-gray-700' }, React.createElement(X))
                        ),
                        React.createElement('p', { className: 'text-gray-600 mb-4' },
                            `총 ${selectedWarehouse.locations.length}개 로케이션, 총 재고: ${
                                (selectedWarehouse.locations.reduce((sum, loc) => sum + (parseInt(String(loc['총재고'] || '0').replace(/,/g, '')) || 0), 0)).toLocaleString()
                            }개`
                        ),
                        React.createElement('div', { className: 'table-container' },
                            React.createElement('table', { className: 'w-full border-collapse border border-gray-300 text-sm' }, 
                                React.createElement('thead', { className: 'bg-gray-50' },
                                    React.createElement('tr', null,
                                        ['로케이션', '유통사', '앨범코드', '앨범명', '아티스트명', '레이블', '내품수', '박스수', '총재고', '메모', '작업'].map(header => 
                                            React.createElement('th', { key: header, className: 'border border-gray-300 px-2 py-2 text-left' }, header)
                                        )
                                    )
                                ),
                                React.createElement('tbody', null,
                                    selectedWarehouse.locations.map((location) =>
                                        React.createElement('tr', { key: location.originalRowIndex, className: 'hover:bg-gray-50' }, 
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2 font-mono' }, location['로케이션번호']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['유통사']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['앨범코드']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['앨범명']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['아티스트명']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['레이블']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2 text-center' }, `${location['내품수']}`),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2 text-center' }, `${location['박스수량']}`),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2 text-center font-semibold text-blue-600' }, `${Number(String(location['총재고'] || '0').replace(/,/g, '')).toLocaleString()}`),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2' }, location['메모']),
                                            React.createElement('td', { className: 'border border-gray-300 px-2 py-2 text-center' },
                                                React.createElement('div', { className: 'flex gap-1 justify-center' },
                                                    React.createElement('button', { 
                                                        onClick: () => handleMixLoad(location),
                                                        className: `p-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600 ${!isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`, 
                                                        title: '이 위치에 다른 상품 혼적', disabled: !isLoggedIn
                                                    }, React.createElement(CopyPlus)),
                                                    React.createElement('button', { onClick: () => startEditLocation(location), className: `px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 ${!isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`, disabled: !isLoggedIn }, '편집'),
                                                    React.createElement('button', { onClick: () => deleteLocation(location.originalRowIndex), className: `px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 ${!isLoggedIn ? 'opacity-50 cursor-not-allowed' : ''}`, disabled: !isLoggedIn }, '삭제')
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        React.createElement('div', { className: 'mt-4 text-center' },
                            React.createElement('button', { onClick: () => setShowWarehouseModal(false), className: 'px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600' }, '닫기')
                        )
                    )
                ),

                // --- 설정 모달 (삭제됨) ---

                // --- 로케이션 추가/관리 모달 (신규 로직 적용됨) ---
                showAddLocation && React.createElement('div', { className: 'modal-overlay' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto' }, 
                        React.createElement('div', { className: 'flex justify-between items-center mb-4 sticky top-0 bg-white z-10 p-1' }, 
                            React.createElement('h2', { className: 'text-xl font-semibold' }, '로케이션 관리 (추가/삭제)'),
                            React.createElement('button', { onClick: () => setShowAddLocation(false), className: 'text-gray-500 hover:text-gray-700' }, React.createElement(X))
                        ),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('div', { className: 'space-y-2 p-4 border rounded bg-gray-50' },
                                React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '창고'), React.createElement('select', { value: newLocation.warehouse || 'A1', onChange: (e) => setNewLocation({...newLocation, warehouse: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded' }, ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].map(wh => React.createElement('option', { key: wh, value: wh }, wh)))),
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '타입'), React.createElement('select', { value: newLocation.type || 'P', onChange: (e) => setNewLocation({...newLocation, type: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded' }, React.createElement('option', { value: 'P' }, 'P (랙)'), React.createElement('option', { value: 'G' }, 'G (그라운드)')))
                                ),
                                (newLocation.type === 'P' || !newLocation.type) ? 
                                    React.createElement('div', { className: 'grid grid-cols-3 gap-2' },
                                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '랙 번호'), React.createElement('input', { type: 'text', value: newLocation.rackNum || '01', onChange: (e) => setNewLocation({...newLocation, rackNum: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '01' })),
                                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '단'), React.createElement('select', { value: newLocation.tier || 'R1', onChange: (e) => setNewLocation({...newLocation, tier: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded' }, React.createElement('option', { value: 'R1' }, 'R1'), React.createElement('option', { value: 'R2' }, 'R2'), React.createElement('option', { value: 'R3' }, 'R3'))),
                                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '칸 번호'), React.createElement('input', { type: 'text', value: newLocation.rackPos || '', onChange: (e) => setNewLocation({...newLocation, rackPos: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '01 (입력)' }))
                                    ) : 
                                    React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '줄 번호'), React.createElement('input', { type: 'text', value: newLocation.groundRow || '01', onChange: (e) => setNewLocation({...newLocation, groundRow: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '01' })),
                                        React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '순서'), React.createElement('input', { type: 'text', value: newLocation.groundPos || '', onChange: (e) => setNewLocation({...newLocation, groundPos: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '01 (입력)' }))
                                    ),
                                React.createElement('div', null,
                                    React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '선택된 로케이션'),
                                    React.createElement('input', { type: 'text', value: generateLocationNumber(newLocation), disabled: true, className: 'w-full px-3 py-2 border border-gray-300 rounded bg-gray-200 font-mono text-center font-bold' })
                                )
                            ),
                            
                            (existingItemsAtLocation.length > 0) && React.createElement('div', { className: 'space-y-2 p-4 border rounded border-blue-300 bg-blue-50' }, 
                                React.createElement('h3', { className: 'font-bold text-blue-700' }, `[${generateLocationNumber(newLocation)}] 기존 적재 목록 (${existingItemsAtLocation.length}건)`),
                                React.createElement('div', { className: 'max-h-32 overflow-y-auto border rounded bg-white' },
                                    existingItemsAtLocation.map(item => 
                                        React.createElement('div', { key: item.originalRowIndex, className: 'flex items-center gap-2 p-2 border-b' },
                                            React.createElement('input', { 
                                                type: 'checkbox', 
                                                id: `del_${item.originalRowIndex}`,
                                                checked: itemsToDeleteSelection.has(item.originalRowIndex),
                                                onChange: () => handleItemDeleteToggle(item.originalRowIndex)
                                            }),
                                            React.createElement('label', { htmlFor: `del_${item.originalRowIndex}`, className: 'text-sm' }, 
                                                `[${item['앨범코드']}] ${item['앨범명']} (${item['총재고']}개) (행: ${item.originalRowIndex})`
                                            )
                                        )
                                    )
                                ),
                                React.createElement('button', {
                                    onClick: handleDeleteSelectedItems,
                                    disabled: itemsToDeleteSelection.size === 0 || isLoading,
                                    className: 'w-full mt-2 px-4 py-2 bg-red-600 text-white rounded disabled:bg-gray-400 hover:bg-red-700 flex items-center justify-center gap-2'
                                }, React.createElement(Trash), `선택한 ${itemsToDeleteSelection.size}개 항목 즉시 삭제`)
                            ),
                            
                            React.createElement('div', { className: 'space-y-3 p-4 border rounded border-gray-300' }, 
                                React.createElement('h3', { className: 'font-bold text-gray-700' }, existingItemsAtLocation.length > 0 ? '[새 상품 혼적]' : '[새 상품 적재]'),
                                React.createElement('div', { className: 'flex gap-2' },
                                    React.createElement('input', { type: 'radio', id: 'add_direct', name: 'inputMode', value: 'direct', checked: inputMode === 'direct', onChange: (e) => setInputMode(e.target.value), className: 'toggle-radio' }),
                                    React.createElement('label', { htmlFor: 'add_direct', className: 'toggle-label' }, '직접 입력'),
                                    React.createElement('input', { type: 'radio', id: 'add_search', name: 'inputMode', value: 'search', checked: inputMode === 'search', onChange: (e) => setInputMode(e.target.value), className: 'toggle-radio' }),
                                    React.createElement('label', { htmlFor: 'add_search', className: 'toggle-label' }, '상품 검색')
                                ),
                                inputMode === 'search' && React.createElement('button', { onClick: () => openProductSearchModal('add'), className: 'w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center justify-center gap-2' }, React.createElement(Search), '통합 상품 검색 팝업 열기'),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '상품코드'), React.createElement('input', { type: 'text', value: newLocation.productCode || '', onChange: (e) => setNewLocation({...newLocation, productCode: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '상품명'), React.createElement('input', { type: 'text', value: newLocation.productName || '', onChange: (e) => setNewLocation({...newLocation, productName: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '아티스트/규격'), React.createElement('input', { type: 'text', value: newLocation.artist || '', onChange: (e) => setNewLocation({...newLocation, artist: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '유통사'), React.createElement('input', { type: 'text', value: newLocation.distributor || '', onChange: (e) => setNewLocation({...newLocation, distributor: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '레이블'), React.createElement('input', { type: 'text', value: newLocation.label || '', onChange: (e) => setNewLocation({...newLocation, label: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '내품수'), React.createElement('input', { type: 'number', value: newLocation.itemsPerBox || '', onChange: (e) => setNewLocation({...newLocation, itemsPerBox: parseInt(e.target.value) || 0}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '0' })),
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '박스수'), React.createElement('input', { type: 'number', value: newLocation.boxCount || '', onChange: (e) => setNewLocation({...newLocation, boxCount: parseInt(e.target.value) || 0}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '0' }))
                                ),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '총 재고 (자동 계산)'), React.createElement('input', { type: 'text', value: ((newLocation.itemsPerBox || 0) * (newLocation.boxCount || 0)).toLocaleString(), disabled: true, className: 'w-full px-3 py-2 border border-gray-300 rounded bg-gray-100' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '메모'), React.createElement('input', { type: 'text', value: newLocation.memo || '', onChange: (e) => setNewLocation({...newLocation, memo: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded' }))
                            ),
                            React.createElement('div', { className: 'flex gap-2 mt-6 sticky bottom-0 bg-white py-4' }, 
                                React.createElement('button', { onClick: addNewLocation, className: 'flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center justify-center gap-2' }, React.createElement(Save), '새 상품 저장 (혼적)'),
                                React.createElement('button', { onClick: () => setShowAddLocation(false), className: 'flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600' }, '닫기')
                            )
                        )
                    )
                ),

                // --- 로케이션 *편집* 모달 ---
                showEditModal && React.createElement('div', { className: 'modal-overlay' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto' }, 
                        React.createElement('div', { className: 'flex justify-between items-center mb-4 sticky top-0 bg-white z-10 p-1' },
                            React.createElement('h2', { className: 'text-xl font-semibold' }, '로케이션 수정'),
                            React.createElement('button', { onClick: () => setShowEditModal(false), className: 'text-gray-500 hover:text-gray-700' }, React.createElement(X))
                        ),
                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('div', { className: 'space-y-2 p-4 border rounded bg-gray-100' },
                                React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '로케이션 번호 (수정불가)'),
                                React.createElement('input', { type: 'text', value: editData.locationNumber, disabled: true, className: 'w-full px-3 py-2 border border-gray-300 rounded bg-gray-200 font-mono text-center font-bold' })
                            ),
                            React.createElement('div', { className: 'space-y-3 p-4 border rounded' },
                                React.createElement('div', { className: 'flex gap-2' },
                                    React.createElement('input', { type: 'radio', id: 'edit_direct', name: 'editInputMode', value: 'direct', checked: inputMode === 'direct', onChange: (e) => setInputMode(e.target.value), className: 'toggle-radio' }),
                                    React.createElement('label', { htmlFor: 'edit_direct', className: 'toggle-label' }, '직접 입력'),
                                    React.createElement('input', { type: 'radio', id: 'edit_search', name: 'editInputMode', value: 'search', checked: inputMode === 'search', onChange: (e) => setInputMode(e.target.value), className: 'toggle-radio' }),
                                    React.createElement('label', { htmlFor: 'edit_search', className: 'toggle-label' }, '상품 검색')
                                ),
                                inputMode === 'search' && React.createElement('button', {
                                    onClick: () => openProductSearchModal('edit'),
                                    className: 'w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center justify-center gap-2'
                                }, React.createElement(Search), '통합 상품 검색 팝업 열기'),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '상품코드'), React.createElement('input', { type: 'text', value: editData.albumCode || '', onChange: (e) => setEditData({...editData, albumCode: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '상품명'), React.createElement('input', { type: 'text', value: editData.albumName || '', onChange: (e) => setEditData({...editData, albumName: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '아티스트/규격'), React.createElement('input', { type: 'text', value: editData.artist || '', onChange: (e) => setEditData({...editData, artist: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '유통사'), React.createElement('input', { type: 'text', value: editData.distributor || '', onChange: (e) => setEditData({...editData, distributor: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '레이블'), React.createElement('input', { type: 'text', value: editData.label || '', onChange: (e) => setEditData({...editData, label: e.target.value}), className: `w-full px-3 py-2 border border-gray-300 rounded ${inputMode === 'search' ? 'bg-gray-100' : ''}`, readOnly: inputMode === 'search' })),
                                React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '내품수'), React.createElement('input', { type: 'number', value: editData.itemsPerBox || '', onChange: (e) => setEditData({...editData, itemsPerBox: parseInt(e.target.value) || 0}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '0' })),
                                    React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '박스수'), React.createElement('input', { type: 'number', value: editData.boxCount || '', onChange: (e) => setEditData({...editData, boxCount: parseInt(e.target.value) || 0}), className: 'w-full px-3 py-2 border border-gray-300 rounded', placeholder: '0' }))
                                ),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '총 재고 (자동 계산)'), React.createElement('input', { type: 'text', value: ((editData.itemsPerBox || 0) * (editData.boxCount || 0)).toLocaleString(), disabled: true, className: 'w-full px-3 py-2 border border-gray-300 rounded bg-gray-100' })),
                                React.createElement('div', null, React.createElement('label', { className: 'block text-sm font-medium mb-1' }, '메모'), React.createElement('input', { type: 'text', value: editData.memo || '', onChange: (e) => setEditData({...editData, memo: e.target.value}), className: 'w-full px-3 py-2 border border-gray-300 rounded' }))
                            ),
                            React.createElement('div', { className: 'flex gap-2 mt-6 sticky bottom-0 bg-white py-4' },
                                React.createElement('button', { onClick: saveLocationEdit, className: 'flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 flex items-center justify-center gap-2' }, React.createElement(Save), '수정 저장'),
                                React.createElement('button', { onClick: () => setShowEditModal(false), className: 'flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600' }, '취소')
                            )
                        )
                    )
                ),
                
                React.createElement(ProductSearchModal, {
                    isOpen: showProductSearchModal,
                    onClose: () => setShowProductSearchModal(false),
                    productData: productData,
                    onSelect: onProductSelectFromModal
                })
            );
        };
        
        const ProductSearchModal = ({ isOpen, onClose, productData, onSelect }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [results, setResults] = useState([]);

            useEffect(() => {
                if (!searchTerm.trim()) {
                    setResults([]); 
                    return;
                }
                const term = searchTerm.toLowerCase();
                const filteredResults = productData.filter(prod => 
                    (prod['관리코드'] || '').toLowerCase().includes(term) ||
                    (prod['바코드'] || '').toLowerCase().includes(term) ||
                    (prod['상품명'] || '').toLowerCase().includes(term) ||
                    (prod['규격'] || '').toLowerCase().includes(term)
                ).slice(0, 50);
                setResults(filteredResults);
            }, [searchTerm, productData]);
            
            if (!isOpen) return null;

            return React.createElement('div', { className: 'modal-overlay' },
                React.createElement('div', { className: 'bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto' },
                    React.createElement('div', { className: 'flex justify-between items-center mb-4' },
                        React.createElement('h2', { className: 'text-xl font-semibold' }, '통합 상품 검색'),
                        React.createElement('button', { onClick: onClose, className: 'text-gray-500 hover:text-gray-700' }, React.createElement(X))
                    ),
                    React.createElement('div', { className: 'mb-4' },
                        React.createElement('input', {
                            type: 'text',
                            placeholder: '관리코드, 바코드, 상품명, 규격으로 검색...',
                            value: searchTerm,
                            onChange: (e) => setSearchTerm(e.target.value),
                            className: 'w-full px-4 py-2 border border-gray-300 rounded-lg',
                            autoFocus: true 
                        })
                    ),
                    React.createElement('div', { className: 'product-search-results' },
                        results.length > 0 ? results.map(prod => 
                            React.createElement('div', {
                                key: prod['관리코드'], 
                                className: 'product-search-item',
                                onClick: () => {
                                    onSelect(prod); 
                                    setSearchTerm(''); 
                                }
                            },
                                React.createElement('p', { className: 'font-semibold' }, `[${prod['관리코드']}] ${prod['상품명']}`),
                                React.createElement('p', { className: 'text-sm text-gray-600' }, `규격: ${prod['규격']} | 유통사: ${prod['소분류명'] || 'N/A'} | 바코드: ${prod['바코드'] || 'N/A'}`)
                            )
                        ) : React.createElement('p', { className: 'p-4 text-gray-500' }, searchTerm ? '검색 결과가 없습니다.' : '검색어를 입력하세요.')
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(InventoryApp), document.getElementById('root'));
    </script>
</body>
</html>
